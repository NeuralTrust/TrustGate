# AI Code Review + Auto Approve for TrustGate (public repo)
# Standalone version - does not use reusable workflows from private repo

name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  ai-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff and files
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files > files.json
          FILE_COUNT=$(jq length files.json)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          if [ $(wc -c < pr_diff.txt) -gt 80000 ]; then
            head -c 80000 pr_diff.txt > pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
          fi

      - name: Get PR info
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} > pr.json
          HEAD_SHA=$(jq -r '.head.sha' pr.json)
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

      - name: AI Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat pr_diff.txt)
          
          cat > request.json << EOF
          {
            "model": "gpt-4o-mini",
            "response_format": { "type": "json_object" },
            "messages": [
              {
                "role": "system",
                "content": "You are an expert code reviewer. Analyze the pull request diff and identify issues. Return a JSON object with this structure:\n\n{\n  \"summary\": \"Brief overall assessment (1-2 sentences)\",\n  \"issues\": [\n    {\n      \"file\": \"path/to/file.go\",\n      \"line\": 42,\n      \"severity\": \"error|warning|suggestion\",\n      \"message\": \"Description of the issue and how to fix it\"\n    }\n  ],\n  \"approved\": true/false\n}\n\nRules:\n- Only report actual issues (bugs, security, performance, bad practices)\n- 'line' must be a line number that appears in the diff (lines starting with +)\n- severity: 'error' for bugs/security, 'warning' for potential issues, 'suggestion' for improvements\n- If no issues found, return empty issues array and approved: true\n- Be concise in messages"
              },
              {
                "role": "user",
                "content": $(echo "$DIFF_CONTENT" | jq -Rs .)
              }
            ],
            "max_tokens": 4000,
            "temperature": 0.2
          }
          EOF
          
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @request.json)
          
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "âŒ OpenAI API Error: $(echo "$RESPONSE" | jq -r '.error.message')"
            echo '{"summary": "", "issues": [], "approved": true, "skip": true}' > review.json
            exit 0
          fi
          
          echo "$RESPONSE" | jq -r '.choices[0].message.content' > review.json
          
          if ! jq empty review.json 2>/dev/null; then
            echo '{"summary": "", "issues": [], "approved": true, "skip": true}' > review.json
          fi
          
          cat review.json

      - name: Post review
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          REVIEW=$(cat review.json)
          SUMMARY=$(echo "$REVIEW" | jq -r '.summary')
          APPROVED=$(echo "$REVIEW" | jq -r '.approved')
          ISSUE_COUNT=$(echo "$REVIEW" | jq '.issues | length')
          SKIP=$(echo "$REVIEW" | jq -r '.skip // false')
          
          if [ "$SKIP" = "true" ]; then
            echo "âš ï¸ Skipping review comment"
            exit 0
          fi
          
          COMMENTS="[]"
          if [ "$ISSUE_COUNT" -gt 0 ]; then
            for i in $(seq 0 $((ISSUE_COUNT - 1))); do
              FILE=$(echo "$REVIEW" | jq -r ".issues[$i].file")
              LINE=$(echo "$REVIEW" | jq -r ".issues[$i].line")
              SEVERITY=$(echo "$REVIEW" | jq -r ".issues[$i].severity")
              MESSAGE=$(echo "$REVIEW" | jq -r ".issues[$i].message")
              
              case "$SEVERITY" in
                error) EMOJI="ðŸš¨" ;;
                warning) EMOJI="âš ï¸" ;;
                suggestion) EMOJI="ðŸ’¡" ;;
                *) EMOJI="ðŸ“" ;;
              esac
              
              BODY="$EMOJI $SEVERITY: $MESSAGE"
              COMMENTS=$(echo "$COMMENTS" | jq \
                --arg path "$FILE" \
                --arg line "$LINE" \
                --arg body "$BODY" \
                '. + [{"path": $path, "line": ($line | tonumber), "body": $body}]')
            done
          fi
          
          if [ "$APPROVED" = "true" ] && [ "$ISSUE_COUNT" -eq 0 ]; then
            EVENT="APPROVE"
            BODY="ðŸ¤– AI Review: âœ… $SUMMARY"
          elif [ "$ISSUE_COUNT" -gt 0 ]; then
            EVENT="REQUEST_CHANGES"
            BODY="ðŸ¤– AI Review: $SUMMARY â€” Found $ISSUE_COUNT issue(s), see inline comments."
          else
            EVENT="COMMENT"
            BODY="ðŸ¤– AI Review: $SUMMARY"
          fi
          
          REVIEW_BODY=$(printf '%s' "$BODY" | jq -Rs .)
          
          cat > review_request.json << EOF
          {
            "commit_id": "${{ steps.pr-info.outputs.head_sha }}",
            "body": $REVIEW_BODY,
            "event": "$EVENT",
            "comments": $COMMENTS
          }
          EOF
          
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
            --method POST \
            --input review_request.json 2>&1 || \
          gh pr comment ${{ github.event.pull_request.number }} --body "$(printf '%b' "$BODY")"

      - name: Fail if critical issues
        run: |
          REVIEW=$(cat review.json)
          ERROR_COUNT=$(echo "$REVIEW" | jq '[.issues[] | select(.severity == "error")] | length')
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âŒ Found $ERROR_COUNT critical issue(s)."
            exit 1
          fi

  auto-approve:
    name: Auto Approve
    runs-on: ubuntu-latest
    needs: ai-review
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for CI checks
        id: wait
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "â³ Waiting for CI checks..."
          
          TIMEOUT=900
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            CHECKS=$(gh api repos/$REPO/commits/$SHA/check-runs --jq '.check_runs' 2>/dev/null || echo "[]")
            
            if [ "$CHECKS" = "[]" ] || [ -z "$CHECKS" ]; then
              sleep 30
              ELAPSED=$((ELAPSED + 30))
              continue
            fi
            
            PENDING=$(echo "$CHECKS" | jq '[.[] | select(.name | test("Auto Approve|AI Code Review|PR Automation") | not) | select(.status != "completed")] | length')
            FAILED=$(echo "$CHECKS" | jq '[.[] | select(.name | test("Auto Approve|AI Code Review|PR Automation") | not) | select(.status == "completed" and .conclusion == "failure")] | length')
            TOTAL=$(echo "$CHECKS" | jq '[.[] | select(.name | test("Auto Approve|AI Code Review|PR Automation") | not)] | length')
            
            echo "Status: $TOTAL checks, $PENDING pending, $FAILED failed"
            
            if [ "$FAILED" -gt 0 ]; then
              echo "âŒ Some checks failed."
              echo "result=failed" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ "$PENDING" -eq 0 ]; then
              echo "âœ… All checks passed!"
              echo "result=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          echo "result=timeout" >> $GITHUB_OUTPUT

      - name: Approve PR
        if: steps.wait.outputs.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "LGTM!"
          echo "âœ… PR approved!"
